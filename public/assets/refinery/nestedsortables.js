/*
 * jQuery UI Nested Sortable
 * v 1.3.4 / 28 apr 2011
 * http://mjsarfatti.com/sandbox/nestedSortable
 *
 * Depends:
 *	 jquery.ui.sortable.js 1.8+
 *
 * License CC BY-SA 3.0
 * Copyright 2010-2011, Manuele J Sarfatti
 */
!function(e){e.widget("ui.nestedSortable",e.extend({},e.ui.sortable.prototype,{options:{tabSize:20,disableNesting:"ui-nestedSortable-no-nesting",errorClass:"ui-nestedSortable-error",listType:"ol",maxLevels:0,noJumpFix:0},_create:function(){return 0==this.noJumpFix&&this.element.height(this.element.height()),this.element.data("sortable",this.element.data("nestedSortable")),e.ui.sortable.prototype._create.apply(this,arguments)},_mouseDrag:function(t){if(this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll){var n=this.options,i=!1;this.scrollParent[0]!=document&&"HTML"!=this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<n.scrollSensitivity?this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop+n.scrollSpeed:t.pageY-this.overflowOffset.top<n.scrollSensitivity&&(this.scrollParent[0].scrollTop=i=this.scrollParent[0].scrollTop-n.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<n.scrollSensitivity?this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft+n.scrollSpeed:t.pageX-this.overflowOffset.left<n.scrollSensitivity&&(this.scrollParent[0].scrollLeft=i=this.scrollParent[0].scrollLeft-n.scrollSpeed)):(t.pageY-e(document).scrollTop()<n.scrollSensitivity?i=e(document).scrollTop(e(document).scrollTop()-n.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<n.scrollSensitivity&&(i=e(document).scrollTop(e(document).scrollTop()+n.scrollSpeed)),t.pageX-e(document).scrollLeft()<n.scrollSensitivity?i=e(document).scrollLeft(e(document).scrollLeft()-n.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<n.scrollSensitivity&&(i=e(document).scrollLeft(e(document).scrollLeft()+n.scrollSpeed))),i!==!1&&e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)}this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"==this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"==this.options.axis||(this.helper[0].style.top=this.position.top+"px");for(var o=this.items.length-1;o>=0;o--){var r=this.items[o],a=r.item[0],s=this._intersectsWithPointer(r);if(s&&a!=this.currentItem[0]&&this.placeholder[1==s?"next":"prev"]()[0]!=a&&!e.contains(this.placeholder[0],a)&&("semi-dynamic"==this.options.type?!e.contains(this.element[0],a):!0)){if(this.direction=1==s?"down":"up","pointer"!=this.options.tolerance&&!this._intersectsWithSides(r))break;this._rearrange(t,r),this._clearEmpty(a),this._trigger("change",t,this._uiHash());break}}var l=this.placeholder[0].parentNode.parentNode&&e(this.placeholder[0].parentNode.parentNode).closest(".ui-sortable").length?e(this.placeholder[0].parentNode.parentNode):null,c=this._getLevel(this.placeholder),u=this._getChildLevels(this.helper),d=this.placeholder[0].previousSibling?e(this.placeholder[0].previousSibling):null;if(null!=d)for(;"li"!=d[0].nodeName.toLowerCase()||d[0]==this.currentItem[0];){if(!d[0].previousSibling){d=null;break}d=e(d[0].previousSibling)}return newList=document.createElement(n.listType),this.beyondMaxLevels=0,null!=l&&this.positionAbs.left<l.offset().left?(l.after(this.placeholder[0]),this._clearEmpty(l[0]),this._trigger("change",t,this._uiHash())):null!=d&&this.positionAbs.left>d.offset().left+n.tabSize?(this._isAllowed(d,c+u+1),d.children(n.listType).length||d[0].appendChild(newList),d.children(n.listType)[0].appendChild(this.placeholder[0]),this._trigger("change",t,this._uiHash())):this._isAllowed(l,c+u),this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(t){if(this.beyondMaxLevels){for(var n=this.placeholder.parent().closest(this.options.items),i=this.beyondMaxLevels-1;i>0;i--)n=n.parent().closest(this.options.items);this.placeholder.removeClass(this.options.errorClass),n.after(this.placeholder),this._trigger("change",t,this._uiHash())}e.ui.sortable.prototype._mouseStop.apply(this,arguments)},serialize:function(t){var n=this._getItemsAsjQuery(t&&t.connected),i=[];return t=t||{},e(n).each(function(){var n=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),o=(e(t.item||this).parent(t.listType).parent("li").attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);n&&i.push((t.key||n[1]+"["+(t.key&&t.expression?n[1]:n[2])+"]")+"="+(o?t.key&&t.expression?o[1]:o[2]:"root"))}),!i.length&&t.key&&i.push(t.key+"="),i.join("&")},toHierarchy:function(t){function n(i){var o=(e(i).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);if(null!=o){var r={id:o[2]};return e(i).children(t.listType).children("li").length>0&&(r.children=[],e(i).children(t.listType).children("li").each(function(){var t=n(e(this));r.children.push(t)})),r}}t=t||{};var i=(t.startDepthCount||0,[]);return e(this.element).children("li").each(function(){var t=n(e(this));i.push(t)}),i},toArray:function(t){function n(e,t){return e.left-t.left}function i(n,a,s){return right=s+1,e(n).children(t.listType).children("li").length>0&&(a++,e(n).children(t.listType).children("li").each(function(){right=i(e(this),a,right)}),a--),id=e(n).attr(t.attribute||"id").match(t.expression||/(.+)[-=_](.+)/),a===o+1?pid="root":(parentItem=e(n).parent(t.listType).parent("li").attr("id").match(t.expression||/(.+)[-=_](.+)/),pid=parentItem[2]),null!=id&&r.push({item_id:id[2],parent_id:pid,depth:a,left:s,right:right}),s=right+1}t=t||{};var o=t.startDepthCount||0,r=[],a=2;return r.push({item_id:"root",parent_id:"none",depth:o,left:"1",right:2*(e("li",this.element).length+1)}),e(this.element).children("li").each(function(){a=i(this,o+1,a)}),r=r.sort(n)},_clear:function(){e.ui.sortable.prototype._clear.apply(this,arguments);for(var t=this.items.length-1;t>=0;t--){var n=this.items[t].item[0];this._clearEmpty(n)}return!0},_clearEmpty:function(e){e.children[1]&&0==e.children[1].children.length&&e.removeChild(e.children[1])},_getLevel:function(e){var t=1;if(this.options.listType)for(var n=e.closest(this.options.listType);!n.is(".ui-sortable");)t++,n=n.parent().closest(this.options.listType);return t},_getChildLevels:function(t,n){var i=this,o=this.options,r=0;return n=n||0,e(t).children(o.listType).children(o.items).each(function(e,t){r=Math.max(i._getChildLevels(t,n+1),r)}),n?r+1:r},_isAllowed:function(e,t){var n=this.options;null!=e&&e.hasClass(n.disableNesting)?(this.placeholder.addClass(n.errorClass),this.beyondMaxLevels=n.maxLevels<t&&0!=n.maxLevels?t-n.maxLevels:1):n.maxLevels<t&&0!=n.maxLevels?(this.placeholder.addClass(n.errorClass),this.beyondMaxLevels=t-n.maxLevels):(this.placeholder.removeClass(n.errorClass),this.beyondMaxLevels=0)}})),e.ui.nestedSortable.prototype.options=e.extend({},e.ui.sortable.prototype.options,e.ui.nestedSortable.prototype.options)}(jQuery);